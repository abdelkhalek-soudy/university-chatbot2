{% extends "base.html" %}

{% block title %}Ø§Ù„Ø´Ø§Øª - Ø¬Ø§Ù…Ø¹Ø© Ø¨Ø§Ø¯ÙŠØ§{% endblock %}

{% block extra_css %}
<style>
    /* Custom logo-based background */
    body {
        background: linear-gradient(135deg, #9370DB 0%, #808080 100%) !important;
        position: relative !important;
    }
    
    body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-image: 
            radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 60%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
        z-index: -2;
        pointer-events: none;
    }
    
    .chat-container {
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
    }
    
    .chat-box {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
    }
    
    .chat-messages {
        height: 400px;
        overflow-y: auto;
        padding: 20px;
        background: rgba(255, 255, 255, 0.5);
    }
    
    .message {
        margin: 15px 0;
        padding: 12px 18px;
        border-radius: 18px;
        max-width: 80%;
        animation: fadeInUp 0.3s ease;
        word-wrap: break-word;
    }
    
    .user-message {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .bot-message {
        background: rgba(248, 249, 250, 0.9);
        color: #333;
        border: 1px solid rgba(0, 0, 0, 0.1);
        margin-right: auto;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .chat-input {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .btn {
        border-radius: 12px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
    }
    
    .form-control {
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.9);
        padding: 12px 15px;
    }
    
    .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        border-color: #667eea;
    }
    
    /* Recording animation */
    .recording {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    /* Typing indicator */
    .typing-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #999;
        animation: typing 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-box">
        <div class="chat-header">
            <h4><i class="fas fa-comments me-2"></i>Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ</h4>
            <p class="mb-0">Ø§Ø³Ø£Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø¬Ø§Ù…Ø¹Ø© Ø¨Ø§Ø¯ÙŠØ§</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                <i class="fas fa-robot me-2"></i>
                Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¬Ø§Ù…Ø¹Ø© Ø¨Ø§Ø¯ÙŠØ§! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ<br>
                <small class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„ÙƒÙ„ÙŠØ§ØªØŒ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙØŒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø£Ùˆ Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</small>
            </div>
        </div>
        
        <div class="chat-input">
            <!-- Text Input -->
            <div class="row g-2 mb-3">
                <div class="col">
                    <input type="text" class="form-control" id="messageInput" 
                           placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù† Ø¬Ø§Ù…Ø¹Ø© Ø¨Ø§Ø¯ÙŠØ§ Ù‡Ù†Ø§..." 
                           onkeypress="handleKeyPress(event)">
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <!-- Audio Recording -->
            <div class="text-center">
                <button id="recordBtn" class="btn btn-danger" onclick="startRecording()">
                    <i class="fas fa-microphone me-2"></i>
                    Ø§Ø¶ØºØ· Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
                </button>
                <button id="stopBtn" class="btn btn-success" onclick="stopRecording()" style="display: none;">
                    <i class="fas fa-stop me-2"></i>
                    Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                </button>
                <div id="recordingStatus" class="mt-2" style="display: none;">
                    <small class="text-danger">
                        <i class="fas fa-circle recording"></i>
                        <span id="recordingText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Simple and reliable audio recording using Web Audio API
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let stream = null;
    let audioContext = null;
    let source = null;
    let processor = null;

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function addMessage(content, isUser = false, messageId = null) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
        
        if (messageId) {
            messageDiv.id = messageId;
        }
        
        if (isUser) {
            messageDiv.innerHTML = `<i class="fas fa-user me-2"></i>${content}`;
        } else {
            messageDiv.innerHTML = `<i class="fas fa-robot me-2"></i>${content}`;
        }
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function updateMessage(messageId, content, isUser = false) {
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            if (isUser) {
                messageElement.innerHTML = `<i class="fas fa-user me-2"></i>${content}`;
            } else {
                messageElement.innerHTML = `<i class="fas fa-robot me-2"></i>${content}`;
            }
        }
    }

    function showTypingIndicator() {
        const messagesContainer = document.getElementById('chatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot-message';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <i class="fas fa-robot me-2"></i>
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    async function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (!message) return;
        
        addMessage(message, true);
        messageInput.value = '';
        
        showTypingIndicator();
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + (localStorage.getItem('access_token') || '')
                },
                body: JSON.stringify({ message })
            });
            
            const data = await response.json();
            hideTypingIndicator();
            
            if (response.ok) {
                addMessage(data.answer);
            } else {
                addMessage(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', false);
            }
        } catch (error) {
            hideTypingIndicator();
            addMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', false);
        }
    }

    // New simplified audio recording
    async function startRecording() {
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const recordingStatus = document.getElementById('recordingStatus');
        const recordingText = document.getElementById('recordingText');
        
        // Reset
        audioChunks = [];
        isRecording = true;
        
        // Update UI
        recordBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        recordingStatus.style.display = 'block';
        recordingText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...';
        
        try {
            // Request microphone with specific constraints
            const constraints = {
                audio: {
                    channelCount: 1,
                    sampleRate: 16000,
                    sampleSize: 16,
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            };
            
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            console.log('Microphone access granted');
            
            // Create MediaRecorder with specific MIME type
            const options = {
                mimeType: 'audio/webm;codecs=opus',
                audioBitsPerSecond: 128000
            };
            
            // Check if the MIME type is supported
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                console.log('audio/webm;codecs=opus not supported, trying audio/webm');
                options.mimeType = 'audio/webm';
            }
            
            mediaRecorder = new MediaRecorder(stream, options);
            
            // Collect audio data
            mediaRecorder.ondataavailable = (event) => {
                if (event.data && event.data.size > 0) {
                    audioChunks.push(event.data);
                    console.log('Audio chunk collected, size:', event.data.size);
                }
            };
            
            // Handle recording stop
            mediaRecorder.onstop = async () => {
                console.log('Recording stopped, chunks:', audioChunks.length);
                
                // Create blob from chunks
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                console.log('Audio blob created, size:', audioBlob.size);
                
                // Send to server
                if (audioBlob.size > 100) {
                    await sendAudioToServer(audioBlob);
                } else {
                    addMessage('âŒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ Ø£Ùˆ ÙØ§Ø±Øº. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', false);
                }
                
                // Cleanup
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                // Reset UI
                recordBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
                recordingStatus.style.display = 'none';
            };
            
            // Start recording with 100ms timeslice
            mediaRecorder.start(100);
            console.log('Recording started');
            
            // Update UI
            let seconds = 0;
            const timer = setInterval(() => {
                if (isRecording) {
                    seconds++;
                    recordingText.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... (${seconds} Ø«Ø§Ù†ÙŠØ©)`;
                } else {
                    clearInterval(timer);
                }
            }, 1000);
            
            // Auto-stop after 30 seconds
            setTimeout(() => {
                if (isRecording) {
                    stopRecording();
                }
            }, 30000);
            
        } catch (error) {
            console.error('Error starting recording:', error);
            addMessage('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.', false);
            
            // Reset UI
            recordBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            recordingStatus.style.display = 'none';
            isRecording = false;
        }
    }
    
    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            isRecording = false;
            mediaRecorder.stop();
            console.log('Stopping recording...');
        }
    }
    
    async function sendAudioToServer(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        
        const messageId = 'msg-' + Date.now();
        addMessage('ğŸ¤ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ...', true, messageId);
        showTypingIndicator();
        
        try {
            const token = localStorage.getItem('access_token') || '';
            
            const response = await fetch('/api/audio-chat', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                body: formData
            });
            
            hideTypingIndicator();
            
            if (response.ok) {
                const data = await response.json();
                
                // Update message with transcript
                if (data.transcript) {
                    updateMessage(messageId, `ğŸ¤ ${data.transcript}`, true);
                }
                
                // Show bot response
                if (data.answer) {
                    addMessage(data.answer, false);
                }
            } else {
                const errorData = await response.json().catch(() => ({}));
                updateMessage(messageId, `âŒ ${errorData.error || 'ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„'}`, true);
            }
        } catch (error) {
            console.error('Error sending audio:', error);
            hideTypingIndicator();
            updateMessage(messageId, 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', true);
        }
    }

    // Language helpers for base.html
    function translateToArabic() {
        try {
            const header = document.querySelector('.chat-header h4');
            const subtitle = document.querySelector('.chat-header p');
            const messageInput = document.getElementById('messageInput');
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (header) header.innerHTML = '<i class="fas fa-comments me-2"></i>Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ';
            if (subtitle) subtitle.textContent = 'Ø§Ø³Ø£Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø¬Ø§Ù…Ø¹Ø© Ø¨Ø§Ø¯ÙŠØ§';
            if (messageInput) messageInput.placeholder = 'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù† Ø¬Ø§Ù…Ø¹Ø© Ø¨Ø§Ø¯ÙŠØ§ Ù‡Ù†Ø§...';
            if (recordBtn) recordBtn.innerHTML = '<i class="fas fa-microphone me-2"></i>Ø§Ø¶ØºØ· Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ';
            if (stopBtn) stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
        } catch(e) { console.warn('translateToArabic failed', e); }
    }

    function translateToEnglish() {
        try {
            const header = document.querySelector('.chat-header h4');
            const subtitle = document.querySelector('.chat-header p');
            const messageInput = document.getElementById('messageInput');
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (header) header.innerHTML = '<i class="fas fa-comments me-2"></i>Smart Chatbot';
            if (subtitle) subtitle.textContent = 'Ask any question about Badya University';
            if (messageInput) messageInput.placeholder = 'Type your question about Badya University here...';
            if (recordBtn) recordBtn.innerHTML = '<i class="fas fa-microphone me-2"></i>Press to Record';
            if (stopBtn) stopBtn.innerHTML = '<i class="fas fa-stop me-2"></i>Stop Recording';
        } catch(e) { console.warn('translateToEnglish failed', e); }
    }
</script>
{% endblock %}
